<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Liste des évaluations</title>

    <style>
        body {
            font-family: Arial;
            margin: 20px;
        }
        .eval-card {
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: #f5f5f5;
        }
        input, select, button {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>

<h2>Évaluations des étudiants</h2>

<h3>Créer une nouvelle évaluation</h3>

<label>Note :</label>
<input type="number" id="note" min="0" max="20">

<label>Étudiant :</label>
<select id="etudiantSelect"></select>

<label>Cours :</label>
<select id="coursSelect"></select>

<button onclick="setEval()">Enregistrer l'évaluation</button>

<hr>

<h3>Liste des évaluations</h3>
<div id="evalContainer"></div>

<script>



const API_BASE = "http://localhost/omeka-s/api";
const TEMPLATE_EVAL = 4;   // ID du template Évaluation dans Omeka
const TEMPLATE_ETU  = 3;   // ID du template Étudiant
const TEMPLATE_COURS = 2;  // ID du template Cours

 


async function loadEtudiants() {
    const res = await fetch(`${API_BASE}/items?resource_template_id=${TEMPLATE_ETU}`);
    const etudiants = await res.json();

    let select = document.getElementById("etudiantSelect");
    etudiants.forEach(e => {
        let name = e["mev:nomEtudiant"]?.[0]?.["@value"] ?? "Sans nom";
        select.innerHTML += `<option value="${e["o:id"]}">${name}</option>`;
    });
}

async function loadCours() {
    const res = await fetch(`${API_BASE}/items?resource_template_id=${TEMPLATE_COURS}`);
    const cours = await res.json();

    let select = document.getElementById("coursSelect");
    cours.forEach(c => {
        let titre = c["dcterms:title"]?.[0]?.["@value"] ?? "Sans titre";
        select.innerHTML += `<option value="${c["o:id"]}">${titre}</option>`;
    });
}



async function setEval() {

    let note = document.getElementById("note").value;
    let etudiantId = document.getElementById("etudiantSelect").value;
    let coursId = document.getElementById("coursSelect").value;

    let data = {
        "o:resource_template": { "o:id": TEMPLATE_EVAL },
        "o:resource_class": { "o:id": null },

        "mev:note": [{
            "type": "literal",
            "@value": note
        }],

        "mev:etudiantEvalue": [{
            "type": "resource",
            "value_resource_id": etudiantId
        }],

        "mev:coursEvalue": [{
            "type": "resource",
            "value_resource_id": coursId
        }]
    };

    const response = await fetch(`${API_BASE}/items`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    });

    alert("Évaluation enregistrée !");
    getEvals();
}


async function getEvals() {
    const res = await fetch(`${API_BASE}/items?resource_template_id=${TEMPLATE_EVAL}`);
    const evals = await res.json();
    showEval(evals);
}

async function showEval(list) {

    let container = document.getElementById("evalContainer");
    container.innerHTML = "";

    for (let e of list) {

        let id = e["o:id"];
        let note = e["mev:note"]?.[0]?.["@value"] ?? "N/A";

        let etudiantId = e["mev:etudiantEvalue"]?.[0]?.["value_resource_id"];
        let coursId    = e["mev:coursEvalue"]?.[0]?.["value_resource_id"];

        // charger les ressources liées
        let etudiant = await fetch(`${API_BASE}/items/${etudiantId}`).then(r => r.json());
        let cours    = await fetch(`${API_BASE}/items/${coursId}`).then(r => r.json());

        let nomEtudiant = etudiant["mev:nomEtudiant"]?.[0]?.["@value"] ?? "Sans nom";
        let nomCours = cours["dcterms:title"]?.[0]?.["@value"] ?? "Sans titre";

        let div = document.createElement("div");
        div.className = "eval-card";

        div.innerHTML = `
            <strong>ID :</strong> ${id}<br>
            <strong>Note :</strong> ${note}/20<br>
            <strong>Étudiant :</strong> ${nomEtudiant}<br>
            <strong>Cours :</strong> ${nomCours}<br>
        `;

        container.appendChild(div);
    }
}


loadEtudiants();
loadCours();
getEvals();

</script>

</body>
</html>
