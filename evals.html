<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Liste des √©valuations</title>

    <style>
        body {
            font-family: Arial;
            margin: 20px;
        }
        .eval-card {
            border: 1px solid #ddd;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: #f5f5f5;
        }
        input, select, button {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>

<h2>√âvaluations des √©tudiants</h2>

<h3>Cr√©er une nouvelle √©valuation</h3>

<label>Note :</label>
<input type="number" id="note" min="0" max="20">

<label>√âtudiant :</label>
<select id="etudiantSelect"></select>

<label>Cours :</label>
<select id="coursSelect"></select>

<button onclick="setEval()">Enregistrer l'√©valuation</button>

<hr>

<h3>Liste des √©valuations</h3>
<div id="evalContainer"></div>

<script>
// ------------------------------
// üîë CONFIG API OMEKA
// ------------------------------
const KEY_ID = "FtmSi7I7u8zaYsBN0XXrnXeLv1JkLDS8";
const KEY_CRED = "aVzeDDS2VcB32Dkmbj0z4g2S6qaE7Gne";

const API_BASE = "http://localhost/omeka-s/api";

const TEMPLATE_EVAL = 4;   // ‚ö†Ô∏è mets ici l‚ÄôID exact de ton template Evaluation
const TEMPLATE_ETU  = 3;   // √âtudiant
const TEMPLATE_COURS = 2;  // Cours



// ------------------------------
// 1Ô∏è‚É£ Charger les √©tudiants (menu d√©roulant)
// ------------------------------
async function loadEtudiants() {
    const res = await fetch(`${API_BASE}/items?resource_template_id=${TEMPLATE_ETU}&key_identity=${KEY_ID}&key_credential=${KEY_CRED}`);
    const etudiants = await res.json();

    let select = document.getElementById("etudiantSelect");
    etudiants.forEach(e => {
        let name = e["mev:nomEtudiant"]?.[0]?.["@value"] ?? "Sans nom";
        select.innerHTML += `<option value="${e["o:id"]}">${name}</option>`;
    });
}



// ------------------------------
// 2Ô∏è‚É£ Charger les cours
// ------------------------------
async function loadCours() {
    const res = await fetch(`${API_BASE}/items?resource_template_id=${TEMPLATE_COURS}&key_identity=${KEY_ID}&key_credential=${KEY_CRED}`);
    const cours = await res.json();

    let select = document.getElementById("coursSelect");
    cours.forEach(c => {
        let titre = c["dcterms:title"]?.[0]?.["@value"] ?? "Sans titre";
        select.innerHTML += `<option value="${c["o:id"]}">${titre}</option>`;
    });
}



// ------------------------------
// 3Ô∏è‚É£ Enregistrer une √©valuation
// ------------------------------
async function setEval() {

    let note = document.getElementById("note").value;
    let etudiantId = document.getElementById("etudiantSelect").value;
    let coursId = document.getElementById("coursSelect").value;

    let data = {
        "o:resource_template": { "o:id": TEMPLATE_EVAL },

        "mev:noteObtenue": [{
            "type": "literal",
            "@value": note
        }],

        "mev:etudiantEvalue": [{
            "type": "resource",
            "value_resource_id": etudiantId
        }],

        "mev:coursEvalue": [{
            "type": "resource",
            "value_resource_id": coursId
        }]
    };

    const response = await fetch(
        `${API_BASE}/items?key_identity=${KEY_ID}&key_credential=${KEY_CRED}`,
        {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        }
    );

    alert("√âvaluation enregistr√©e !");
    getEvals();
}



// ------------------------------
// 4Ô∏è‚É£ R√©cup√©rer la liste des √©valuations
// ------------------------------
async function getEvals() {
    const res = await fetch(
        `${API_BASE}/items?resource_template_id=${TEMPLATE_EVAL}&key_identity=${KEY_ID}&key_credential=${KEY_CRED}`
    );
    const evals = await res.json();
    showEval(evals);
}



// ------------------------------
// 5Ô∏è‚É£ Afficher les √©valuations
// ------------------------------
async function showEval(list) {

    let container = document.getElementById("evalContainer");
    container.innerHTML = "";

    for (let e of list) {

        let id = e["o:id"];
        let note = e["mev:noteObtenue"]?.[0]?.["@value"] ?? "N/A";

        let etudiantId = e["mev:etudiantEvalue"]?.[0]?.["value_resource_id"];
        let coursId    = e["mev:coursEvalue"]?.[0]?.["value_resource_id"];

        // Charger √©tudiant et cours
        let etudiant = await fetch(`${API_BASE}/items/${etudiantId}?key_identity=${KEY_ID}&key_credential=${KEY_CRED}`).then(r => r.json());
        let cours    = await fetch(`${API_BASE}/items/${coursId}?key_identity=${KEY_ID}&key_credential=${KEY_CRED}`).then(r => r.json());

        let nomEtudiant = etudiant["mev:nomEtudiant"]?.[0]?.["@value"] ?? "Sans nom";
        let nomCours = cours["dcterms:title"]?.[0]?.["@value"] ?? "Sans titre";

        let div = document.createElement("div");
        div.className = "eval-card";

        div.innerHTML = `
            <strong>ID :</strong> ${id}<br>
            <strong>Note :</strong> ${note}/20<br>
            <strong>√âtudiant :</strong> ${nomEtudiant}<br>
            <strong>Cours :</strong> ${nomCours}<br>
        `;

        container.appendChild(div);
    }
}



// ------------------------------
// Charger tout au d√©marrage
// ------------------------------
loadEtudiants();
loadCours();
getEvals();

</script>

</body>
</html>
