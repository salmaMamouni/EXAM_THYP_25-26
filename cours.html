<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Liste des cours</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h2 { margin-bottom: 20px; }

        #search {
            padding: 10px;
            width: 100%;
            font-size: 15px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .cours-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            background: #f9f9f9;
        }
        .cours-card strong { color: #333; }

        .student {
            margin-left: 10px;
            color: #555;
        }
    </style>
</head>
<body>

<h2>Liste des cours</h2>

<input type="text" id="search" placeholder="Filtrer les cours..." onkeyup="filterCours()">

<div id="coursContainer"></div>

<script>
// ----------------------------
// CONFIGURATION API OMEKA-S
// ----------------------------
const KEY_ID = "FtmSi7I7u8zaYsBN0XXrnXeLv1JkLDS8";
const KEY_CRED = "aVzeDDS2VcB32Dkmbj0z4g2S6qaE7Gne";

// ID du template Cours
const TEMPLATE_COURS = 2;

// URL API complète
const API_URL = `http://localhost/omeka-s/api/items?resource_template_id=${TEMPLATE_COURS}&key_identity=${KEY_ID}&key_credential=${KEY_CRED}`;


// ----------------------------
// 1) Récupération des cours
// ----------------------------
async function getCours() {
    try {
        const response = await fetch(API_URL);
        const data = await response.json();
        showCours(data);
    } catch (e) {
        console.error("Erreur API :", e);
    }
}


// ----------------------------
// 2) Affichage des cours
// ----------------------------
async function showCours(coursList) {
    let container = document.getElementById("coursContainer");
    container.innerHTML = "";

    for (let cours of coursList) {

        let id = cours["o:id"];
        let titre = cours["dcterms:title"]?.[0]?.["@value"] ?? "Sans titre";
        let description = cours["dcterms:description"]?.[0]?.["@value"] ?? "Aucune description";

        // Chercher les étudiants inscrits à ce cours
        let students = await getEtudiantsInscrits(id);

        let card = document.createElement("div");
        card.className = "cours-card";

        card.innerHTML = `
            <strong>ID :</strong> ${id}<br>
            <strong>Titre :</strong> ${titre}<br>
            <strong>Description :</strong> ${description}<br><br>
            <strong>Étudiants inscrits :</strong> ${students.length}<br>
            ${students.map(s => `<div class="student">• ${s}</div>`).join("")}
        `;

        container.appendChild(card);
    }
}


// ----------------------------
// 3) Chercher les étudiants inscrits à un cours
// ----------------------------
async function getEtudiantsInscrits(coursId) {

    const url = `http://localhost/omeka-s/api/items?resource_template_id=3&key_identity=${KEY_ID}&key_credential=${KEY_CRED}`;
    const response = await fetch(url);
    const etudiants = await response.json();

    let inscrits = [];

    etudiants.forEach(et => {
        let inscritDans = et["mev:inscritDansLeCours"]?.[0]?.["@id"];
        if (inscritDans && inscritDans.endsWith("/" + coursId)) {
            inscrits.push(et["dcterms:title"]?.[0]?.["@value"] ?? "Étudiant sans nom");
        }
    });

    return inscrits;
}


// ----------------------------
// 4) Filtrage des cours
// ----------------------------
function filterCours() {
    let search = document.getElementById("search").value.toLowerCase();
    let cards = document.querySelectorAll(".cours-card");

    cards.forEach(card => {
        card.style.display = card.innerText.toLowerCase().includes(search)
            ? "block"
            : "none";
    });
}

// ----------------------------
// Lancement initial
// ----------------------------
getCours();

</script>

</body>
</html>
